{% extends "base.html" %}

{% block title %}{{ event.name }} - {{ competition.competition.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/components.css">
<link rel="stylesheet" href="/static/css/bracket.css">
{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb">
        <a href="/">ëŒ€íšŒ ëª©ë¡</a> &gt;
        <a href="/competition/{{ competition.competition.event_cd }}">{{ competition.competition.name }}</a> &gt;
        <span>{{ event.name }}</span>
    </nav>

    <!-- Event Header -->
    <section class="competition-header">
        <h1>{{ event.name }}</h1>
        <div class="competition-meta">
            <span class="meta-item">
                <strong>ëŒ€íšŒ:</strong> {{ competition.competition.name }}
            </span>
            <span class="meta-item">
                <strong>ê¸°ê°„:</strong>
                {{ competition.competition.start_date or '-' }}
                {% if competition.competition.end_date and competition.competition.end_date != competition.competition.start_date %}
                ~ {{ competition.competition.end_date }}
                {% endif %}
            </span>
            <span class="meta-item">
                <strong>ì°¸ê°€:</strong> {{ event.total_participants or (event.final_rankings|length) or '-' }}ëª…
            </span>
            <span class="meta-item">
                {% if event.weapon %}<span class="weapon-tag">{{ event.weapon }}</span>{% endif %}
                {% if event.gender %}<span class="gender-tag">{{ event.gender }}</span>{% endif %}
                {% if event.event_type %}<span class="type-tag">{{ event.event_type }}</span>{% endif %}
            </span>
        </div>
    </section>

    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="pools">
            <span class="tab-icon">ğŸ“‹</span>
            <span>Pool</span>
        </button>
        <button class="tab-btn" data-tab="tournament">
            <span class="tab-icon">ğŸ†</span>
            <span>Direct Elimination</span>
        </button>
        <button class="tab-btn" data-tab="final">
            <span class="tab-icon">ğŸ¥‡</span>
            <span>ìµœì¢…ê²°ê³¼</span>
        </button>
    </div>

    <!-- Tab Contents -->
    <div id="tab-pools" class="tab-content active">
        {% if event.pool_rounds %}
        <div class="pool-selector">
            {% for pool in event.pool_rounds %}
            <button class="pool-btn{% if loop.first %} active{% endif %}" data-pool="{{ loop.index }}">Pool {{ loop.index }}</button>
            {% endfor %}
            {% if event.pool_total_ranking %}
            <button class="pool-btn pool-total-btn" data-pool="total">Pool Total</button>
            {% endif %}
        </div>

        <!-- Pool Total Ranking Section -->
        {% if event.pool_total_ranking %}
        <div class="pool-container pool-item" data-pool-id="total" style="display:none">
            <div class="pool-title">
                <h4>Pool ìµœì¢… ë­í‚¹</h4>
                <span class="pool-info">ì „ì²´ {{ event.pool_total_ranking|length }}ëª…</span>
            </div>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th style="text-align:left">ì´ë¦„</th>
                        <th style="text-align:left">ì†Œì†</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in event.pool_total_ranking %}
                    <tr>
                        <td class="rank">{{ player.rank }}</td>
                        <td class="player-name"><a href="/player/{{ player.name|urlencode }}?team={{ player.team|urlencode }}">{{ player.name }}</a></td>
                        <td>{{ player.team }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% for pool in event.pool_rounds %}
        <div class="pool-container pool-item" data-pool-id="{{ loop.index }}">
            <div class="pool-title">
                <h4>Pool {{ loop.index }}</h4>
                <span class="pool-info">
                    {% if pool.piste %}í”¼ìŠ¤íŠ¸: {{ pool.piste }} | {% endif %}
                    {% if pool.time %}ì‹œê°„: {{ pool.time }} | {% endif %}
                    {% if pool.referee %}ì‹¬íŒ: {{ pool.referee }}{% endif %}
                </span>
            </div>

            <!-- Pool Standings -->
            <table class="result-table">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th style="text-align:left">ì´ë¦„</th>
                        <th style="text-align:left">ì†Œì†</th>
                        <th>ìŠ¹</th>
                        <th>íŒ¨</th>
                        <th>ì§€ìˆ˜</th>
                        <th>ë“ì </th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in pool.results|sort(attribute='rank') %}
                    <tr>
                        <td class="rank">{{ player.rank or '-' }}</td>
                        <td class="player-name"><a href="/player/{{ player.name|urlencode }}?team={{ player.team|urlencode }}">{{ player.name }}</a></td>
                        <td>{{ player.team }}</td>
                        <td>{{ player.wins or 0 }}</td>
                        <td>{{ player.losses or 0 }}</td>
                        <td>{% if player.indicator > 0 %}+{% endif %}{{ player.indicator or 0 }}</td>
                        <td>{{ player.touches or player.score or 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pool Matrix (if scores available) -->
            {% if pool.results and pool.results[0].scores %}
            <div class="bout-list">
                <div class="bout-list-header" onclick="togglePoolMatrix(this)">
                    <span>ğŸ“Š ëŒ€ì§„í‘œ ë³´ê¸°</span>
                    <span class="result-expand-icon">â–¼</span>
                </div>
                <div class="pool-matrix" style="display:none">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>ì´ë¦„</th>
                                {% for p in pool.results %}
                                <th>{{ loop.index }}</th>
                                {% endfor %}
                                <th>ìŠ¹</th>
                                <th>íŒ¨</th>
                                <th>ì§€ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player in pool.results %}
                            <tr>
                                <td><strong>{{ loop.index }}</strong></td>
                                <td class="player-col"><a href="/player/{{ player.name|urlencode }}?team={{ player.team|urlencode }}">{{ player.name }}</a></td>
                                {% for score in player.scores %}
                                    {% if score is none %}
                                    <td class="self">X</td>
                                    {% elif score.type == 'V' %}
                                    <td class="victory">V{{ score.score }}</td>
                                    {% else %}
                                    <td class="defeat">{{ score.score }}</td>
                                    {% endif %}
                                {% endfor %}
                                <td class="stats-col">{{ player.wins or 0 }}</td>
                                <td class="stats-col">{{ player.losses or 0 }}</td>
                                <td class="stats-col">{% if player.indicator > 0 %}+{% endif %}{{ player.indicator or 0 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Individual Bouts -->
            {% if pool.bouts %}
            <div class="bout-list">
                <div class="bout-list-header" onclick="toggleBoutList(this)">
                    <span>âš”ï¸ ê°œë³„ ê²½ê¸° ({{ pool.bouts|length }}ê²½ê¸°)</span>
                    <span class="result-expand-icon">â–¼</span>
                </div>
                <div class="bout-items" style="display:none">
                    {% for bout in pool.bouts %}
                    <div class="bout-item">
                        <div class="bout-players">
                            <div class="bout-player {% if bout.winner_name == bout.player1_name %}winner{% else %}loser{% endif %}">
                                <div><a href="/player/{{ bout.player1_name|urlencode }}?team={{ bout.player1_team|urlencode }}">{{ bout.player1_name }}</a></div>
                                <small>{{ bout.player1_team }}</small>
                            </div>
                            <div class="bout-score">
                                {{ bout.player1_score }} - {{ bout.player2_score }}
                            </div>
                            <div class="bout-player {% if bout.winner_name == bout.player2_name %}winner{% else %}loser{% endif %}">
                                <div><a href="/player/{{ bout.player2_name|urlencode }}?team={{ bout.player2_team|urlencode }}">{{ bout.player2_name }}</a></div>
                                <small>{{ bout.player2_team }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="empty">Pool ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        {% endif %}
    </div>

    <div id="tab-tournament" class="tab-content">
        {% if event.normalized_bracket and event.normalized_bracket.rounds %}
        {# ìƒˆë¡œìš´ ì •ê·œí™”ëœ ëŒ€ì§„í‘œ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© #}
        {% set bracket = event.normalized_bracket %}
        {% include 'components/bracket.html' %}
        {% elif event.de_bracket or event.de_seeding %}
        {# ë ˆê±°ì‹œ ëŒ€ì§„í‘œ ë°ì´í„° (ì •ê·œí™” ì•ˆëœ ê²½ìš° - í´ë°±) #}
        <div class="bracket-container">
            <div class="bracket-controls">
                <div class="bracket-info">
                    <span class="participant-count">{{ event.de_seeding|length if event.de_seeding else '-' }}ëª… ì°¸ê°€</span>
                </div>
            </div>
            {% if event.de_seeding %}
            <details class="bracket-seeding">
                <summary class="seeding-header">
                    <span class="seeding-icon">&#127919;</span>
                    <span>Seeding ({{ event.de_seeding|length }}ëª…)</span>
                    <span class="seeding-toggle">+</span>
                </summary>
                <div class="seeding-grid">
                    {% for player in event.de_seeding|sort(attribute='seed') %}
                    {% if not loop.previtem or loop.previtem.seed != player.seed %}
                    <div class="seeding-item">
                        <span class="seeding-rank">{{ player.seed }}</span>
                        <a href="/player/{{ player.name|urlencode }}?team={{ player.team|urlencode }}" class="seeding-name">{{ player.name }}</a>
                        <span class="seeding-team">{{ player.team }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </details>
            {% endif %}
            {% if event.de_bracket %}
            <div class="bracket-list-view active">
                {% set rounds = event.de_rounds if event.de_rounds else ['64ê°•', '32ê°•', '16ê°•', '8ê°•', 'ì¤€ê²°ìŠ¹', 'ê²°ìŠ¹'] %}
                <div class="round-tabs" role="tablist">
                    {% for round_name in rounds %}
                    {% if event.de_bracket.get(round_name) %}
                    <button class="round-tab {% if loop.last %}active{% endif %}"
                            role="tab"
                            data-round="{{ round_name }}">
                        {{ round_name }}
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
                {% for round_name in rounds %}
                {% if event.de_bracket.get(round_name) %}
                <div class="round-panel {% if loop.last %}active{% endif %}" data-round-panel="{{ round_name }}">
                    <div class="round-title-mobile">
                        <span class="round-icon">&#9876;</span>
                        {{ round_name }} <span class="match-count">({{ event.de_bracket[round_name]|length }}ê²½ê¸°)</span>
                    </div>
                    <div class="match-cards">
                        {% for match in event.de_bracket[round_name] %}
                        <article class="match-card">
                            <div class="match-header">
                                <span class="match-number">Match {{ loop.index }}</span>
                                {% if match.winner_name %}
                                <span class="match-status complete">ì™„ë£Œ</span>
                                {% else %}
                                <span class="match-status pending">ì˜ˆì •</span>
                                {% endif %}
                            </div>
                            <div class="match-content">
                                <div class="card-player {% if match.winner_seed == match.player1_seed %}winner{% endif %}">
                                    <div class="player-info">
                                        <span class="player-seed-badge">{{ match.player1_seed }}</span>
                                        <div class="player-details">
                                            <a href="/player/{{ match.player1_name|urlencode }}?team={{ match.player1_team|urlencode }}" class="player-name">{{ match.player1_name }}</a>
                                            <span class="player-team">{{ match.player1_team }}</span>
                                        </div>
                                    </div>
                                    <span class="player-score-badge {% if match.winner_seed == match.player1_seed %}winning{% endif %}">
                                        {{ match.player1_score if match.player1_score is not none else '-' }}
                                    </span>
                                </div>
                                <div class="match-vs">VS</div>
                                <div class="card-player {% if match.winner_seed == match.player2_seed %}winner{% endif %}">
                                    <div class="player-info">
                                        <span class="player-seed-badge">{{ match.player2_seed }}</span>
                                        <div class="player-details">
                                            <a href="/player/{{ match.player2_name|urlencode }}?team={{ match.player2_team|urlencode }}" class="player-name">{{ match.player2_name }}</a>
                                            <span class="player-team">{{ match.player2_team }}</span>
                                        </div>
                                    </div>
                                    <span class="player-score-badge {% if match.winner_seed == match.player2_seed %}winning{% endif %}">
                                        {{ match.player2_score if match.player2_score is not none else '-' }}
                                    </span>
                                </div>
                            </div>
                            {% if match.winner_name %}
                            <div class="match-footer">
                                <span class="winner-label">&#127942; Winner:</span>
                                <a href="/player/{{ match.winner_name|urlencode }}" class="winner-name">{{ match.winner_name }}</a>
                            </div>
                            {% endif %}
                        </article>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="empty">
            <p>DE (Direct Elimination) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p style="font-size: 0.9rem; color: var(--text-light);">ëŒ€ì§„í‘œ ë°ì´í„° ìˆ˜ì§‘ ì˜ˆì •ì…ë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>

    <div id="tab-final" class="tab-content">
        {% if event.final_rankings %}
        <!-- Podium -->
        <div class="podium-section">
            <h3>ğŸ† ì‹œìƒëŒ€</h3>
            <div class="podium">
                {% set silver = event.final_rankings|selectattr('rank', 'equalto', 2)|first %}
                {% set gold = event.final_rankings|selectattr('rank', 'equalto', 1)|first %}
                {% set bronzes = event.final_rankings|selectattr('rank', 'equalto', 3)|list %}

                {% if silver %}
                <div class="podium-place second">
                    <div class="podium-medal">ğŸ¥ˆ</div>
                    <div class="podium-box">
                        <div class="podium-name"><a href="/player/{{ silver.name|urlencode }}?team={{ silver.team|urlencode }}">{{ silver.name }}</a></div>
                        <div class="podium-team">{{ silver.team }}</div>
                    </div>
                    <div class="podium-rank">2ìœ„</div>
                </div>
                {% endif %}

                {% if gold %}
                <div class="podium-place first">
                    <div class="podium-medal">ğŸ¥‡</div>
                    <div class="podium-box">
                        <div class="podium-name"><a href="/player/{{ gold.name|urlencode }}?team={{ gold.team|urlencode }}">{{ gold.name }}</a></div>
                        <div class="podium-team">{{ gold.team }}</div>
                    </div>
                    <div class="podium-rank">1ìœ„</div>
                </div>
                {% endif %}

                {% if bronzes %}
                <div class="podium-place third">
                    <div class="podium-medal">ğŸ¥‰</div>
                    <div class="podium-box">
                        {% for bronze in bronzes %}
                        <div class="podium-name"><a href="/player/{{ bronze.name|urlencode }}?team={{ bronze.team|urlencode }}">{{ bronze.name }}</a></div>
                        <div class="podium-team">{{ bronze.team }}</div>
                        {% if not loop.last %}<hr style="margin: 8px 0; opacity: 0.3">{% endif %}
                        {% endfor %}
                    </div>
                    <div class="podium-rank">{% if bronzes|length > 1 %}ê³µë™ {% endif %}3ìœ„</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Full Rankings -->
        <table class="final-table">
            <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>ì´ë¦„</th>
                    <th>ì†Œì†</th>
                    <th>ìˆœìœ„/ì°¸ê°€</th>
                    <th>í¬ì¸íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% set total_participants = event.final_rankings|length %}
                {% for ranking in event.final_rankings %}
                <tr>
                    <td class="rank-cell {% if ranking.rank == 1 %}gold{% elif ranking.rank == 2 %}silver{% elif ranking.rank == 3 %}bronze{% endif %}">
                        {% if ranking.rank == 1 %}ğŸ¥‡{% elif ranking.rank == 2 %}ğŸ¥ˆ{% elif ranking.rank == 3 %}ğŸ¥‰{% else %}{{ ranking.rank }}{% endif %}
                    </td>
                    <td class="name-cell">
                        <a href="/player/{{ ranking.name|urlencode }}?team={{ ranking.team|urlencode }}">{{ ranking.name }}</a>
                    </td>
                    <td>{{ ranking.team }}</td>
                    <td class="place-cell">{{ ranking.rank }}/{{ total_participants }}</td>
                    <td class="points-cell">{% if ranking.points %}{{ "%.1f"|format(ranking.points) }}pt{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Stats Summary -->
        <div class="stats-summary-box">
            <div class="stat-item">
                <div class="value">{{ event.final_rankings|length }}</div>
                <div class="label">ì°¸ê°€ ì¸ì›</div>
            </div>
            <div class="stat-item">
                <div class="value">{{ event.final_rankings|map(attribute='team')|unique|list|length }}</div>
                <div class="label">ì°¸ê°€ íŒ€</div>
            </div>
        </div>
        {% else %}
        <div class="empty">ìµœì¢… ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        {% endif %}
    </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// Pool selector
document.querySelectorAll('.pool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.pool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const poolId = btn.dataset.pool;
        document.querySelectorAll('.pool-item').forEach(pool => {
            pool.style.display = pool.dataset.poolId === poolId ? 'block' : 'none';
        });
    });
});

// Initialize: show only first pool (not Pool Total)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.pool-item').forEach((pool) => {
        // Show only Pool 1, hide Pool Total and other pools
        pool.style.display = pool.dataset.poolId === '1' ? 'block' : 'none';
    });
});

// DE Round tabs
document.querySelectorAll('.de-round-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.de-round-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const round = btn.dataset.deRound;
        document.querySelectorAll('.de-round-content').forEach(content => {
            content.classList.remove('active');
            if (content.dataset.deRoundContent === round) {
                content.classList.add('active');
            }
        });
    });
});

// Toggle DE list
function toggleDEList(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.result-expand-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        icon.textContent = 'â–¼';
    }
}

// Legacy bracket round tabs (for fallback mode)
document.querySelectorAll('.bracket-list-view .round-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        const container = btn.closest('.bracket-list-view');
        const round = btn.dataset.round;

        container.querySelectorAll('.round-tab').forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');

        container.querySelectorAll('.round-panel').forEach(panel => {
            panel.classList.toggle('active', panel.dataset.roundPanel === round);
        });
    });
});

// Toggle functions
function togglePoolMatrix(header) {
    const matrix = header.nextElementSibling;
    const icon = header.querySelector('.result-expand-icon');
    if (matrix.style.display === 'none') {
        matrix.style.display = 'block';
        icon.textContent = 'â–²';
    } else {
        matrix.style.display = 'none';
        icon.textContent = 'â–¼';
    }
}

function toggleBoutList(header) {
    const bouts = header.nextElementSibling;
    const icon = header.querySelector('.result-expand-icon');
    if (bouts.style.display === 'none') {
        bouts.style.display = 'block';
        icon.textContent = 'â–²';
    } else {
        bouts.style.display = 'none';
        icon.textContent = 'â–¼';
    }
}

function toggleSeeding(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.result-expand-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        icon.textContent = 'â–¼';
    }
}
</script>
{% endblock %}
