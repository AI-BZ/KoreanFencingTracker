{% extends "base.html" %}

{% block title %}ë‚´ í”„ë¡œí•„ - Korean Fencing Tracker{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-avatar">
                {{ member.full_name[0] if member.full_name else 'U' }}
            </div>
            <div class="profile-info">
                <h1>{{ member.full_name }}</h1>
                <p class="member-type">
                    {% if member.member_type == 'player' %}ì„ ìˆ˜íšŒì›
                    {% elif member.member_type == 'player_parent' %}ì„ ìˆ˜ ë¶€ëª¨íšŒì›
                    {% elif member.member_type == 'club_coach' %}í´ëŸ½ ì½”ì¹˜
                    {% elif member.member_type == 'school_coach' %}í•™êµ ì½”ì¹˜
                    {% else %}ì¼ë°˜ íšŒì›
                    {% endif %}
                </p>
                <div class="verification-badge badge-{{ member.verification_status }}">
                    {% if member.verification_status == 'verified' %}
                    âœ… ì¸ì¦ ì™„ë£Œ
                    {% elif member.verification_status == 'submitted' %}
                    â³ ì¸ì¦ ê²€í† ì¤‘
                    {% elif member.verification_status == 'rejected' %}
                    âŒ ì¸ì¦ ê±°ë¶€ë¨
                    {% else %}
                    ğŸ“‹ ì¸ì¦ ëŒ€ê¸°
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="profile-section">
            <h2>ê¸°ë³¸ ì •ë³´</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>ì´ë©”ì¼</label>
                    <span>{{ member.email }}</span>
                </div>
                <div class="info-item">
                    <label>ì—°ë½ì²˜</label>
                    <span>{{ member.phone or '-' }}</span>
                </div>
                <div class="info-item">
                    <label>ê°€ì…ì¼</label>
                    <span>{{ member.created_at[:10] if member.created_at else '-' }}</span>
                </div>
            </div>
        </div>

        <!-- ê°œì¸ì •ë³´ ì„¤ì • -->
        <div class="profile-section">
            <h2>ê°œì¸ì •ë³´ ì„¤ì •</h2>
            <form id="privacyForm" class="privacy-form">
                <label class="toggle-item">
                    <span class="toggle-label">
                        <strong>ì •ë³´ ê³µê°œ</strong>
                        <p>ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ì‹¤ëª…ê³¼ ì†Œì†ì„ ê³µê°œí•©ë‹ˆë‹¤</p>
                    </span>
                    <input type="checkbox" name="privacy_public"
                        {{ 'checked' if member.privacy_public else '' }}>
                    <span class="toggle-switch"></span>
                </label>

                <label class="toggle-item">
                    <span class="toggle-label">
                        <strong>ë§ˆì¼€íŒ… ìˆ˜ì‹ </strong>
                        <p>ì´ë²¤íŠ¸ ë° í”„ë¡œëª¨ì…˜ ì •ë³´ë¥¼ ë°›ìŠµë‹ˆë‹¤</p>
                    </span>
                    <input type="checkbox" name="marketing_consent"
                        {{ 'checked' if member.marketing_consent else '' }}>
                    <span class="toggle-switch"></span>
                </label>

                <label class="toggle-item">
                    <span class="toggle-label">
                        <strong>í™ë³´ ì—°ë™</strong>
                        <p>SNS í™ë³´ ì½˜í…ì¸ ì— ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</p>
                    </span>
                    <input type="checkbox" name="promotional_consent"
                        {{ 'checked' if member.promotional_consent else '' }}>
                    <span class="toggle-switch"></span>
                </label>

                <button type="submit" class="save-btn">ì €ì¥</button>
            </form>
        </div>

        <!-- ê³µê°œ í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="profile-section">
            <h2>ê³µê°œ í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°</h2>
            <div class="preview-card">
                <div class="preview-name">
                    {% if member.privacy_public %}
                    {{ member.full_name }}
                    {% else %}
                    {{ member.display_name or 'H.G.D.' }}
                    {% endif %}
                </div>
                <div class="preview-team">
                    {% if member.privacy_public %}
                    {{ team_name or 'ì†Œì† ë¯¸ë“±ë¡' }}
                    {% else %}
                    {{ anonymous_team or 'ì„œìš¸(í´ëŸ½)' }}
                    {% endif %}
                </div>
            </div>
            <p class="preview-note">
                {% if member.privacy_public %}
                í˜„ì¬ ê³µê°œ ì„¤ì •: ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‹¤ëª…ê³¼ ì†Œì†ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                {% else %}
                í˜„ì¬ ë¹„ê³µê°œ ì„¤ì •: ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ì´ë‹ˆì…œê³¼ ì§€ì—­ë§Œ í‘œì‹œë©ë‹ˆë‹¤
                {% endif %}
            </p>
        </div>

        <!-- ì—°ê²°ëœ ê³„ì • -->
        <div class="profile-section">
            <h2>ì—°ê²°ëœ ê³„ì •</h2>
            <div class="oauth-list">
                {% for oauth in oauth_connections %}
                <div class="oauth-item">
                    <span class="oauth-icon">
                        {% if oauth.provider == 'kakao' %}ğŸ’¬
                        {% elif oauth.provider == 'google' %}ğŸ”
                        {% else %}âœ–ï¸
                        {% endif %}
                    </span>
                    <div class="oauth-info">
                        <strong>{{ oauth.provider|title }}</strong>
                        <span>{{ oauth.provider_email or oauth.provider_name or 'ì—°ê²°ë¨' }}</span>
                    </div>
                    {% if oauth.is_primary %}
                    <span class="primary-badge">ê¸°ë³¸</span>
                    {% endif %}
                </div>
                {% else %}
                <p class="no-oauth">ì—°ê²°ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>
                {% endfor %}
            </div>

            {% if not has_x_connection %}
            <a href="/auth/login/x?promotional=true" class="add-oauth-btn">
                âœ–ï¸ X(Twitter) í™ë³´ ê³„ì • ì—°ê²°í•˜ê¸°
            </a>
            {% endif %}
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ -->
        <div class="profile-actions">
            <a href="/auth/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</div>

<style>
.profile-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
}

.profile-card {
    background: var(--card-bg, #fff);
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    overflow: hidden;
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
}

.profile-info h1 {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.member-type {
    opacity: 0.9;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.verification-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.badge-verified { background: rgba(255,255,255,0.9); color: #22543d; }
.badge-submitted { background: rgba(255,255,255,0.9); color: #744210; }
.badge-rejected { background: rgba(255,255,255,0.9); color: #742a2a; }
.badge-pending { background: rgba(255,255,255,0.9); color: #4a5568; }

.profile-section {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #eee;
}

.profile-section h2 {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--text-secondary, #666);
}

.info-grid {
    display: grid;
    gap: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-item label {
    font-size: 0.8rem;
    color: var(--text-secondary, #888);
}

.info-item span {
    font-size: 1rem;
}

.privacy-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.toggle-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    cursor: pointer;
}

.toggle-label {
    flex: 1;
}

.toggle-label strong {
    display: block;
    margin-bottom: 0.25rem;
}

.toggle-label p {
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
    margin: 0;
}

.toggle-item input {
    display: none;
}

.toggle-switch {
    width: 50px;
    height: 26px;
    background: #cbd5e0;
    border-radius: 13px;
    position: relative;
    transition: background 0.2s;
}

.toggle-switch::after {
    content: '';
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: left 0.2s;
}

.toggle-item input:checked + .toggle-switch {
    background: var(--primary-color, #3182ce);
}

.toggle-item input:checked + .toggle-switch::after {
    left: 26px;
}

.save-btn {
    padding: 0.75rem 1.5rem;
    background: var(--primary-color, #3182ce);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    align-self: flex-start;
    margin-top: 0.5rem;
}

.save-btn:hover {
    background: #2c5282;
}

.preview-card {
    background: #f7fafc;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.preview-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.preview-team {
    color: var(--text-secondary, #666);
    font-size: 0.9rem;
}

.preview-note {
    font-size: 0.8rem;
    color: var(--text-secondary, #888);
    margin-top: 0.75rem;
}

.oauth-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.oauth-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: #f7fafc;
    border-radius: 8px;
}

.oauth-icon {
    font-size: 1.5rem;
}

.oauth-info {
    flex: 1;
}

.oauth-info strong {
    display: block;
    font-size: 0.9rem;
}

.oauth-info span {
    font-size: 0.8rem;
    color: var(--text-secondary, #666);
}

.primary-badge {
    background: var(--primary-color, #3182ce);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
}

.no-oauth {
    color: var(--text-secondary, #888);
    font-size: 0.9rem;
}

.add-oauth-btn {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    border: 1px dashed #cbd5e0;
    border-radius: 8px;
    color: var(--text-secondary, #666);
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.add-oauth-btn:hover {
    border-color: var(--primary-color, #3182ce);
    color: var(--primary-color, #3182ce);
}

.profile-actions {
    padding: 1.5rem 2rem;
    text-align: center;
}

.logout-btn {
    color: #e53e3e;
    text-decoration: none;
    font-size: 0.9rem;
}

.logout-btn:hover {
    text-decoration: underline;
}
</style>

<script>
document.getElementById('privacyForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = {
        privacy_public: this.querySelector('[name="privacy_public"]').checked,
        marketing_consent: this.querySelector('[name="marketing_consent"]').checked,
        promotional_consent: this.querySelector('[name="promotional_consent"]').checked
    };

    try {
        const response = await fetch('/auth/me/privacy', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            location.reload();
        } else {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
});
</script>
{% endblock %}
