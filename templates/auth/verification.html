{% extends "base.html" %}

{% block title %}ë³¸ì¸ ì¸ì¦ - Korean Fencing Tracker{% endblock %}

{% block content %}
<div class="verification-container">
    <div class="verification-card">
        <div class="verification-header">
            <h1>ì„ ìˆ˜ ì¸ì¦</h1>
            <p>íœì‹± ì„ ìˆ˜ì„ì„ ì¸ì¦í•˜ë©´ ëª¨ë“  ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>

        <!-- í˜„ì¬ ì¸ì¦ ìƒíƒœ -->
        <div class="verification-status status-{{ member.verification_status }}">
            {% if member.verification_status == 'verified' %}
                <span class="status-icon">âœ…</span>
                <span>ì¸ì¦ ì™„ë£Œ</span>
            {% elif member.verification_status == 'submitted' %}
                <span class="status-icon">â³</span>
                <span>ê²€í†  ì¤‘</span>
            {% elif member.verification_status == 'rejected' %}
                <span class="status-icon">âŒ</span>
                <span>ì¸ì¦ ê±°ë¶€ - ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</span>
            {% else %}
                <span class="status-icon">ğŸ“‹</span>
                <span>ì¸ì¦ ëŒ€ê¸° ì¤‘</span>
            {% endif %}
        </div>

        <!-- ì¸ì¦ ë°©ë²• ì„ íƒ -->
        {% if member.verification_status != 'verified' %}
        <div class="verification-methods">
            <h2>ì¸ì¦ ë°©ë²• ì„ íƒ</h2>

            <div class="method-cards">
                {% for vt in verification_types %}
                <div class="method-card" data-type="{{ vt.value }}">
                    <div class="method-icon">
                        {% if vt.value == 'association_card' %}
                        ğŸ“‡
                        {% elif vt.value == 'mask_photo' %}
                        ğŸ­
                        {% else %}
                        ğŸ‘•
                        {% endif %}
                    </div>
                    <h3>{{ vt.label }}</h3>
                    <p class="method-desc">
                        {% if vt.value == 'association_card' %}
                        ëŒ€í•œíœì‹±í˜‘íšŒ ë“±ë¡ì¦ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”
                        {% elif vt.value == 'mask_photo' %}
                        íœì‹± ë§ˆìŠ¤í¬ì™€ í•¨ê»˜<br>ì´ë¦„/ë‚ ì§œë¥¼ ì ì€ ì¢…ì´ë¥¼ ì´¬ì˜
                        {% else %}
                        íœì‹± ë„ë³µê³¼ í•¨ê»˜<br>ì´ë¦„/ë‚ ì§œë¥¼ ì ì€ ì¢…ì´ë¥¼ ì´¬ì˜
                        {% endif %}
                    </p>
                    <button class="select-btn" onclick="selectMethod('{{ vt.value }}')">
                        ì„ íƒ
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- ì—…ë¡œë“œ í¼ -->
            <div class="upload-section" id="uploadSection" style="display: none;">
                <h3 id="uploadTitle">ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>

                <div class="upload-guide" id="uploadGuide"></div>

                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" name="verification_type" id="verificationType">

                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" name="file" accept="image/*" style="display: none;">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <span class="upload-icon">ğŸ“·</span>
                            <p>í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                            <p class="upload-hint">JPG, PNG, WEBP (ìµœëŒ€ 10MB)</p>
                        </div>
                        <img id="previewImage" style="display: none; max-width: 100%; border-radius: 8px;">
                    </div>

                    <button type="submit" class="upload-btn" id="uploadBtn" disabled>
                        ì¸ì¦ ìš”ì²­í•˜ê¸°
                    </button>
                </form>

                <div class="upload-result" id="uploadResult" style="display: none;"></div>
            </div>
        </div>
        {% endif %}

        <!-- ì¸ì¦ ë‚´ì—­ -->
        {% if verifications %}
        <div class="verification-history">
            <h2>ì¸ì¦ ë‚´ì—­</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ìœ í˜•</th>
                        <th>ìƒíƒœ</th>
                        <th>ì‹ ë¢°ë„</th>
                        <th>ì¶”ì¶œëœ ì´ë¦„</th>
                        <th>ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in verifications %}
                    <tr class="status-row-{{ v.status }}">
                        <td>
                            {% if v.verification_type == 'association_card' %}
                            í˜‘íšŒ ë“±ë¡ì¦
                            {% elif v.verification_type == 'mask_photo' %}
                            ë§ˆìŠ¤í¬ ì‚¬ì§„
                            {% else %}
                            ë„ë³µ ì‚¬ì§„
                            {% endif %}
                        </td>
                        <td>
                            {% if v.status == 'approved' %}
                            <span class="badge badge-success">ìŠ¹ì¸</span>
                            {% elif v.status == 'rejected' %}
                            <span class="badge badge-danger">ê±°ë¶€</span>
                            {% elif v.status == 'processing' %}
                            <span class="badge badge-warning">ì²˜ë¦¬ì¤‘</span>
                            {% else %}
                            <span class="badge badge-secondary">ëŒ€ê¸°</span>
                            {% endif %}
                        </td>
                        <td>{{ (v.gemini_confidence * 100)|round(1) if v.gemini_confidence else '-' }}%</td>
                        <td>{{ v.extracted_name or '-' }}</td>
                        <td>{{ v.created_at[:10] if v.created_at else '-' }}</td>
                    </tr>
                    {% if v.rejection_reason %}
                    <tr class="rejection-reason">
                        <td colspan="5">ê±°ë¶€ ì‚¬ìœ : {{ v.rejection_reason }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<style>
.verification-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

.verification-card {
    background: var(--card-bg, #fff);
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    padding: 2rem;
}

.verification-header {
    text-align: center;
    margin-bottom: 2rem;
}

.verification-header h1 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.verification-header p {
    color: var(--text-secondary, #666);
}

.verification-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    font-weight: 500;
}

.verification-status.status-verified {
    background: #c6f6d5;
    color: #22543d;
}

.verification-status.status-submitted {
    background: #fefcbf;
    color: #744210;
}

.verification-status.status-rejected {
    background: #fed7d7;
    color: #742a2a;
}

.verification-status.status-pending {
    background: #e2e8f0;
    color: #4a5568;
}

.status-icon {
    font-size: 1.25rem;
}

.verification-methods h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.method-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.method-card {
    background: #f7fafc;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
}

.method-card:hover {
    border-color: var(--primary-color, #3182ce);
}

.method-card.selected {
    border-color: var(--primary-color, #3182ce);
    background: #ebf8ff;
}

.method-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
}

.method-card h3 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.method-desc {
    font-size: 0.8rem;
    color: var(--text-secondary, #666);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.select-btn {
    padding: 0.5rem 1.5rem;
    background: var(--primary-color, #3182ce);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
}

.select-btn:hover {
    background: #2c5282;
}

.upload-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
}

.upload-section h3 {
    margin-bottom: 1rem;
}

.upload-guide {
    background: #fffbeb;
    border-left: 4px solid #f59e0b;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0 8px 8px 0;
    font-size: 0.9rem;
    line-height: 1.6;
}

.upload-area {
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 1rem;
}

.upload-area:hover {
    border-color: var(--primary-color, #3182ce);
    background: #f7fafc;
}

.upload-area.dragover {
    border-color: var(--primary-color, #3182ce);
    background: #ebf8ff;
}

.upload-placeholder {
    color: var(--text-secondary, #666);
}

.upload-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 0.5rem;
}

.upload-hint {
    font-size: 0.8rem;
    color: #a0aec0;
    margin-top: 0.5rem;
}

.upload-btn {
    width: 100%;
    padding: 1rem;
    background: var(--primary-color, #3182ce);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
}

.upload-btn:disabled {
    background: #cbd5e0;
    cursor: not-allowed;
}

.upload-result {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
}

.upload-result.success {
    background: #c6f6d5;
    color: #22543d;
}

.upload-result.error {
    background: #fed7d7;
    color: #742a2a;
}

.verification-history {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
}

.verification-history h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.history-table th,
.history-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.history-table th {
    background: #f7fafc;
    font-weight: 600;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success { background: #c6f6d5; color: #22543d; }
.badge-danger { background: #fed7d7; color: #742a2a; }
.badge-warning { background: #fefcbf; color: #744210; }
.badge-secondary { background: #e2e8f0; color: #4a5568; }

.rejection-reason {
    background: #fff5f5;
}

.rejection-reason td {
    font-size: 0.85rem;
    color: #742a2a;
    padding-left: 1.5rem;
}
</style>

<script>
const guides = {
    'association_card': 'ëŒ€í•œíœì‹±í˜‘íšŒ ë“±ë¡ì¦ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”. ì´ë¦„, ë“±ë¡ë²ˆí˜¸, ì†Œì†ì´ ë³´ì´ë„ë¡ ì´¬ì˜í•˜ì„¸ìš”.',
    'mask_photo': 'íœì‹± ë§ˆìŠ¤í¬ì™€ í•¨ê»˜ <strong>ì˜¤ëŠ˜ ë‚ ì§œ</strong>ì™€ <strong>ë³¸ì¸ ì´ë¦„</strong>ì„ ì ì€ ì¢…ì´ë¥¼ ë“¤ê³  ì´¬ì˜í•˜ì„¸ìš”.<br>ë§ˆìŠ¤í¬ì— ì´ë¦„ì´ ìˆë‹¤ë©´ í•¨ê»˜ ë³´ì´ë„ë¡ ì´¬ì˜í•˜ì„¸ìš”.',
    'uniform_photo': 'íœì‹± ë„ë³µê³¼ í•¨ê»˜ <strong>ì˜¤ëŠ˜ ë‚ ì§œ</strong>ì™€ <strong>ë³¸ì¸ ì´ë¦„</strong>ì„ ì ì€ ì¢…ì´ë¥¼ ë“¤ê³  ì´¬ì˜í•˜ì„¸ìš”.<br>ë„ë³µì— ì´ë¦„ì´ ìˆë‹¤ë©´ í•¨ê»˜ ë³´ì´ë„ë¡ ì´¬ì˜í•˜ì„¸ìš”.'
};

function selectMethod(type) {
    // ì¹´ë“œ ì„ íƒ ìƒíƒœ
    document.querySelectorAll('.method-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');

    // ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('verificationType').value = type;
    document.getElementById('uploadGuide').innerHTML = guides[type];

    // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
    document.getElementById('previewImage').style.display = 'none';
    document.getElementById('uploadPlaceholder').style.display = 'block';
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadBtn').disabled = true;
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const placeholder = document.getElementById('uploadPlaceholder');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadResult = document.getElementById('uploadResult');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            showPreview(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            showPreview(e.target.files[0]);
        }
    });

    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
            placeholder.style.display = 'none';
            uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';

        const formData = new FormData(uploadForm);

        try {
            const response = await fetch('/auth/verification/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            uploadResult.style.display = 'block';
            if (result.success) {
                uploadResult.className = 'upload-result success';
                uploadResult.innerHTML = `
                    <strong>${result.message}</strong><br>
                    ${result.extracted_name ? 'ì¶”ì¶œëœ ì´ë¦„: ' + result.extracted_name : ''}
                    ${result.confidence ? ' (ì‹ ë¢°ë„: ' + (result.confidence * 100).toFixed(1) + '%)' : ''}
                `;

                if (result.status === 'approved') {
                    setTimeout(() => location.reload(), 2000);
                }
            } else {
                uploadResult.className = 'upload-result error';
                uploadResult.textContent = result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
            }
        } catch (error) {
            uploadResult.style.display = 'block';
            uploadResult.className = 'upload-result error';
            uploadResult.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
        }

        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ì¸ì¦ ìš”ì²­í•˜ê¸°';
    });
});
</script>
{% endblock %}
