{% extends "base.html" %}

{% block title %}íšŒê³„ê´€ë¦¬ - Korean Fencing Tracker{% endblock %}

{% block extra_css %}
<style>
.accounting-page {
    padding: 2rem 0;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 1.8rem;
    color: #1a1a2e;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f5f5f5;
    color: #333;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.9rem;
}

.back-btn:hover {
    background: #eee;
}

/* Summary Cards */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.summary-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.summary-card h3 {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.summary-value {
    font-size: 2rem;
    font-weight: 700;
}

.summary-value.warning {
    color: #f5a623;
}

.summary-value.danger {
    color: #e53935;
}

.summary-value.success {
    color: #4caf50;
}

.summary-value.primary {
    color: #667eea;
}

/* Fees Section */
.fees-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.fees-section h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #1a1a2e;
}

.fees-table {
    width: 100%;
    border-collapse: collapse;
}

.fees-table th,
.fees-table td {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.fees-table th {
    font-weight: 600;
    color: #666;
    font-size: 0.85rem;
    text-transform: uppercase;
}

.fees-table tr:hover {
    background: #f8f9ff;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.pending {
    background: #fff3e0;
    color: #e65100;
}

.status-badge.overdue {
    background: #ffebee;
    color: #c62828;
}

.status-badge.paid {
    background: #e8f5e9;
    color: #2e7d32;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.4rem 0.8rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
}

.action-btn:hover {
    background: #5a6fd6;
}

.action-btn.secondary {
    background: #f5f5f5;
    color: #333;
}

/* Access Denied */
.access-denied {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.access-denied .icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.access-denied h2 {
    color: #e53935;
    margin-bottom: 0.5rem;
}

.access-denied p {
    color: #666;
}

/* Loading */
.loading {
    text-align: center;
    padding: 3rem;
    color: #888;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: #888;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.tab-btn {
    padding: 0.6rem 1.2rem;
    background: #f5f5f5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.tab-btn.active {
    background: #667eea;
    color: white;
}

.tab-btn:hover:not(.active) {
    background: #eee;
}
</style>
{% endblock %}

{% block content %}
<div class="container accounting-page">
    <div class="page-header">
        <h1>ğŸ’° íšŒê³„ê´€ë¦¬</h1>
        <a href="/club/" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div id="accountingContent">
        <div class="loading">íšŒê³„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// í…ŒìŠ¤íŠ¸ ëª¨ë“œ (dashboard.htmlê³¼ ë™ì¼)
const TEST_MODE = true;
const API_BASE = '/api/club';
const API_SUFFIX = TEST_MODE ? '?test=1' : '';

async function loadAccountingData() {
    const container = document.getElementById('accountingContent');

    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };

        // ëŒ€ì‹œë³´ë“œ APIì—ì„œ ë¹„ìš© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`${API_BASE}/dashboard${API_SUFFIX}`, { headers });

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/auth/login?redirect=/club/accounting';
                return;
            }
            if (response.status === 403) {
                renderAccessDenied();
                return;
            }
            throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await response.json();

        // íšŒê³„ ìƒì„¸ API í˜¸ì¶œ (ë³„ë„)
        const feesResponse = await fetch(`${API_BASE}/accounting/summary${API_SUFFIX}`, { headers });
        let feesData = {};
        if (feesResponse.ok) {
            feesData = await feesResponse.json();
        }

        renderAccounting(data, feesData);

    } catch (error) {
        console.error('Accounting error:', error);
        container.innerHTML = `
            <div class="access-denied">
                <div class="icon">âš ï¸</div>
                <h2>ì˜¤ë¥˜ ë°œìƒ</h2>
                <p>íšŒê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <a href="/club/" class="action-btn" style="margin-top: 1rem; display: inline-block;">ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</a>
            </div>
        `;
    }
}

function renderAccessDenied() {
    document.getElementById('accountingContent').innerHTML = `
        <div class="access-denied">
            <div class="icon">ğŸ”’</div>
            <h2>ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
            <p>íšŒê³„ê´€ë¦¬ëŠ” í´ëŸ½ ëŒ€í‘œ(ì‚¬ì¥)ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <a href="/club/" class="action-btn" style="margin-top: 1rem; display: inline-block;">ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</a>
        </div>
    `;
}

function renderAccounting(dashboardData, feesData) {
    const container = document.getElementById('accountingContent');

    const pendingFees = dashboardData.pending_fees || 0;
    const overdueFees = dashboardData.overdue_fees || 0;
    const thisMonthCollection = dashboardData.this_month_collection || 0;
    const totalOutstanding = pendingFees + overdueFees;

    container.innerHTML = `
        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>ë¯¸ë‚© í•©ê³„</h3>
                <div class="summary-value warning">${formatCurrency(pendingFees)}ì›</div>
            </div>
            <div class="summary-card">
                <h3>ì—°ì²´ í•©ê³„</h3>
                <div class="summary-value danger">${formatCurrency(overdueFees)}ì›</div>
            </div>
            <div class="summary-card">
                <h3>ì´ë²ˆ ë‹¬ ìˆ˜ê¸ˆ</h3>
                <div class="summary-value success">${formatCurrency(thisMonthCollection)}ì›</div>
            </div>
            <div class="summary-card">
                <h3>ë¯¸ìˆ˜ê¸ˆ ì´ì•¡</h3>
                <div class="summary-value primary">${formatCurrency(totalOutstanding)}ì›</div>
            </div>
        </div>

        <!-- Pending Fees -->
        <div class="fees-section">
            <h2>ğŸ“‹ ë¯¸ë‚©/ì—°ì²´ ë‚´ì—­</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="filterFees('all')">ì „ì²´</button>
                <button class="tab-btn" onclick="filterFees('pending')">ë¯¸ë‚©</button>
                <button class="tab-btn" onclick="filterFees('overdue')">ì—°ì²´</button>
            </div>
            <div id="feesTableContent">
                <div class="loading">ë‚´ì—­ ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- Monthly Summary -->
        <div class="fees-section">
            <h2>ğŸ“Š ì›”ë³„ ìˆ˜ê¸ˆ í˜„í™©</h2>
            <div id="monthlySummary">
                <div class="empty-state">ì›”ë³„ ë°ì´í„°ëŠ” ì¶”í›„ ì œê³µ ì˜ˆì •ì…ë‹ˆë‹¤.</div>
            </div>
        </div>
    `;

    // Load fees detail
    loadFeesDetail();
}

async function loadFeesDetail() {
    const container = document.getElementById('feesTableContent');

    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };

        const response = await fetch(`${API_BASE}/accounting/fees${API_SUFFIX}`, { headers });

        if (!response.ok) {
            // APIê°€ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ë°ì´í„° í‘œì‹œ
            renderTestFeesData();
            return;
        }

        const data = await response.json();
        renderFeesTable(data.fees || []);

    } catch (error) {
        console.error('Fees error:', error);
        renderTestFeesData();
    }
}

function renderTestFeesData() {
    // í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° (API ë¯¸êµ¬í˜„ ì‹œ)
    const testFees = [
        { member_name: 'ë°•ì†Œìœ¤', fee_type: 'ì›”íšŒë¹„', amount: 150000, status: 'pending', due_date: '2024-12-10' },
        { member_name: 'ì•ˆí˜¸ìœ¤', fee_type: 'ì›”íšŒë¹„', amount: 150000, status: 'pending', due_date: '2024-12-10' },
        { member_name: 'ì´ê·œí˜„', fee_type: 'ì›”íšŒë¹„', amount: 150000, status: 'overdue', due_date: '2024-11-10' },
    ];
    renderFeesTable(testFees);
}

function renderFeesTable(fees) {
    const container = document.getElementById('feesTableContent');

    if (!fees || fees.length === 0) {
        container.innerHTML = '<div class="empty-state">ë¯¸ë‚©/ì—°ì²´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <table class="fees-table">
            <thead>
                <tr>
                    <th>íšŒì›ëª…</th>
                    <th>ìœ í˜•</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ê¸°í•œ</th>
                    <th>ìƒíƒœ</th>
                    <th>ì•¡ì…˜</th>
                </tr>
            </thead>
            <tbody>
                ${fees.map(fee => `
                    <tr data-status="${fee.status}">
                        <td><strong>${fee.member_name}</strong></td>
                        <td>${getFeeTypeLabel(fee.fee_type)}</td>
                        <td>${formatCurrency(fee.amount)}ì›</td>
                        <td>${fee.due_date || '-'}</td>
                        <td><span class="status-badge ${fee.status}">${getStatusLabel(fee.status)}</span></td>
                        <td>
                            <button class="action-btn" onclick="markAsPaid('${fee.id}')">ë‚©ë¶€í™•ì¸</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function filterFees(status) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Filter table rows
    document.querySelectorAll('.fees-table tbody tr').forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

async function markAsPaid(feeId) {
    if (!confirm('ë‚©ë¶€ ì™„ë£Œë¡œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const headers = {
            'Content-Type': 'application/json',
            ...(TEST_MODE ? {} : {'Authorization': `Bearer ${localStorage.getItem('access_token')}`})
        };

        const response = await fetch(`${API_BASE}/accounting/fees/${feeId}/paid${API_SUFFIX}`, {
            method: 'POST',
            headers
        });

        if (response.ok) {
            alert('ë‚©ë¶€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAccountingData();  // Reload
        } else {
            alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Mark as paid error:', error);
        alert('ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Helpers
function formatCurrency(amount) {
    return new Intl.NumberFormat('ko-KR').format(amount || 0);
}

function getFeeTypeLabel(type) {
    const labels = {
        'membership': 'ì›”íšŒë¹„',
        'lesson': 'ë ˆìŠ¨ë¹„',
        'competition': 'ëŒ€íšŒë¹„',
        'equipment': 'ì¥ë¹„ë¹„',
        'uniform': 'ìœ ë‹ˆí¼ë¹„',
        'registration': 'ë“±ë¡ë¹„',
        'other': 'ê¸°íƒ€'
    };
    return labels[type] || type;
}

function getStatusLabel(status) {
    const labels = {
        'pending': 'ë¯¸ë‚©',
        'overdue': 'ì—°ì²´',
        'paid': 'ë‚©ë¶€ì™„ë£Œ',
        'waived': 'ë©´ì œ'
    };
    return labels[status] || status;
}

// Initialize
document.addEventListener('DOMContentLoaded', loadAccountingData);
</script>
{% endblock %}
