{% extends "base.html" %}

{% block title %}í´ëŸ½ ëŒ€ì‹œë³´ë“œ - Korean Fencing Tracker{% endblock %}

{% block extra_css %}
<style>
.club-dashboard {
    padding: 2rem 0;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    font-size: 1.8rem;
    color: #1a1a2e;
}

.dashboard-header .club-name {
    color: #667eea;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.dashboard-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.card-header h3 {
    font-size: 1rem;
    color: #666;
    font-weight: 500;
}

.card-header .icon {
    font-size: 1.5rem;
}

.card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1a1a2e;
}

.card-value.highlight {
    color: #667eea;
}

.card-value.warning {
    color: #f5a623;
}

.card-value.success {
    color: #4caf50;
}

.card-subtitle {
    font-size: 0.9rem;
    color: #888;
    margin-top: 0.5rem;
}

/* Team Roster */
.roster-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.roster-section h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #1a1a2e;
}

.roster-table {
    width: 100%;
    border-collapse: collapse;
}

.roster-table th,
.roster-table td {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.roster-table th {
    font-weight: 600;
    color: #666;
    font-size: 0.85rem;
    text-transform: uppercase;
}

.roster-table tr:hover {
    background: #f8f9ff;
}

.player-name {
    font-weight: 600;
    color: #1a1a2e;
}

.player-name a {
    color: inherit;
    text-decoration: none;
}

.player-name a:hover {
    color: #667eea;
}

.role-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.role-badge.coach {
    background: #e3f2fd;
    color: #1976d2;
}

.role-badge.student {
    background: #f3e5f5;
    color: #7b1fa2;
}

.role-badge.owner {
    background: #fff3e0;
    color: #e65100;
}

.weapon-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    background: #f5f5f5;
    color: #666;
}

.stat-value {
    font-weight: 600;
    color: #667eea;
}

/* Today's Attendance */
.attendance-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.attendance-section h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #1a1a2e;
}

.checkin-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checkin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 0;
    border-bottom: 1px solid #eee;
}

.checkin-item:last-child {
    border-bottom: none;
}

.checkin-name {
    font-weight: 600;
}

.checkin-time {
    color: #888;
    font-size: 0.9rem;
}

.checkin-type {
    font-size: 0.8rem;
    color: #667eea;
}

/* Alerts */
.alerts-section {
    margin-bottom: 2rem;
}

.alert {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.alert.warning {
    background: #fff8e1;
    border: 1px solid #ffcc02;
}

.alert.info {
    background: #e3f2fd;
    border: 1px solid #90caf9;
}

.alert.error {
    background: #ffebee;
    border: 1px solid #ef9a9a;
}

.alert-icon {
    font-size: 1.2rem;
}

/* Loading */
.loading {
    text-align: center;
    padding: 3rem;
    color: #888;
}

.loading::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: #888;
}

/* Actions */
.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.action-btn:hover {
    background: #5a6fd6;
}

.action-btn.secondary {
    background: #f5f5f5;
    color: #333;
}

.action-btn.secondary:hover {
    background: #eee;
}
</style>
{% endblock %}

{% block content %}
<div class="container club-dashboard">
    <div class="dashboard-header">
        <h1>
            <span class="club-name" id="clubName">Loading...</span> ëŒ€ì‹œë³´ë“œ
        </h1>
        <div class="actions" id="headerActions">
            <button class="action-btn" onclick="location.href='/club/checkin'">
                âœ“ ì¶œì„ ì²´í¬ì¸
            </button>
            <!-- íšŒê³„ê´€ë¦¬ ë²„íŠ¼ì€ ownerì—ê²Œë§Œ ë™ì ìœ¼ë¡œ í‘œì‹œ -->
        </div>
    </div>

    <!-- Alerts -->
    <div class="alerts-section" id="alertsSection"></div>

    <!-- Stats Grid -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì˜¤ëŠ˜ ì¶œì„</h3>
                <span class="icon">ğŸ“‹</span>
            </div>
            <div class="card-value highlight" id="todayAttendance">-</div>
            <div class="card-subtitle">ëª… ì²´í¬ì¸</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì „ì²´ íšŒì›</h3>
                <span class="icon">ğŸ‘¥</span>
            </div>
            <div class="card-value" id="totalMembers">-</div>
            <div class="card-subtitle">ìˆ˜ê°•ìƒ <span id="studentCount">-</span>ëª… / ì½”ì¹˜ <span id="coachCount">-</span>ëª…</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì´ë²ˆ ì£¼ í›ˆë ¨</h3>
                <span class="icon">ğŸ—“ï¸</span>
            </div>
            <div class="card-value" id="weeklyTraining">-</div>
            <div class="card-subtitle">íšŒ ì˜ˆì •</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì˜ˆì • ëŒ€íšŒ</h3>
                <span class="icon">ğŸ†</span>
            </div>
            <div class="card-value" id="upcomingComps">-</div>
            <div class="card-subtitle">ê±´</div>
        </div>
    </div>

    <!-- Team Roster -->
    <div class="roster-section">
        <h2>ğŸ† ì†Œì† ì„ ìˆ˜ í˜„í™©</h2>
        <div id="rosterContent">
            <div class="loading">ì„ ìˆ˜ ë°ì´í„° ë¡œë”© ì¤‘</div>
        </div>
    </div>

    <!-- Today's Attendance -->
    <div class="attendance-section">
        <h2>ğŸ“‹ ì˜¤ëŠ˜ ì¶œì„ í˜„í™©</h2>
        <div id="attendanceContent">
            <div class="loading">ì¶œì„ ë°ì´í„° ë¡œë”© ì¤‘</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ê¸°ë³¸ í™œì„±í™” (ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì™„ì„± ì „ê¹Œì§€)
// TODO: ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì™„ì„± í›„ falseë¡œ ë³€ê²½
const TEST_MODE = true;
const API_BASE = '/api/club';
const API_SUFFIX = TEST_MODE ? '?test=1' : '';

// ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
async function loadDashboard() {
    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };
        const response = await fetch(`${API_BASE}/dashboard${API_SUFFIX}`, { headers });

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/auth/login?redirect=/club/';
                return;
            }
            throw new Error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await response.json();
        renderDashboard(data);

    } catch (error) {
        console.error('Dashboard error:', error);
        document.querySelector('.club-dashboard').innerHTML = `
            <div class="empty-state">
                <p>ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p><a href="/auth/login?redirect=/club/">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>
        `;
    }
}

function renderDashboard(data) {
    // Club name
    document.getElementById('clubName').textContent = data.organization_name;

    // Stats
    document.getElementById('todayAttendance').textContent = data.today_attendance;
    document.getElementById('totalMembers').textContent = data.total_members;
    document.getElementById('studentCount').textContent = data.active_students;
    document.getElementById('coachCount').textContent = data.active_coaches;
    document.getElementById('weeklyTraining').textContent = data.weekly_training || 5;  // ê¸°ë³¸ê°’
    document.getElementById('upcomingComps').textContent = data.upcoming_competitions?.length || 0;

    // Alerts (ë¹„ìš© ê´€ë ¨ ì•Œë¦¼ì€ í•„í„°ë§ - ownerë§Œ íšŒê³„ê´€ë¦¬ì—ì„œ í™•ì¸)
    const filteredAlerts = (data.alerts || []).filter(a => a.alert_type !== 'overdue_fee');
    renderAlerts(filteredAlerts);

    // Attendance
    renderAttendance(data.today_checkins);

    // Load team roster separately
    loadTeamRoster();

    // íšŒê³„ê´€ë¦¬ ë²„íŠ¼ ì¶”ê°€ (ownerë§Œ)
    // TEST_MODEì—ì„œëŠ” ownerë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë²„íŠ¼ í‘œì‹œ
    if (TEST_MODE) {
        addAccountingButton();
    }
}

function addAccountingButton() {
    const actionsDiv = document.getElementById('headerActions');
    if (!actionsDiv.querySelector('.accounting-btn')) {
        const btn = document.createElement('button');
        btn.className = 'action-btn secondary accounting-btn';
        btn.innerHTML = 'ğŸ’° íšŒê³„ê´€ë¦¬';
        btn.onclick = () => location.href = '/club/accounting';
        actionsDiv.appendChild(btn);
    }
}

function renderAlerts(alerts) {
    const container = document.getElementById('alertsSection');
    if (!alerts || alerts.length === 0) {
        container.innerHTML = '';
        return;
    }

    const icons = {
        'warning': 'âš ï¸',
        'info': 'â„¹ï¸',
        'error': 'ğŸš¨'
    };

    container.innerHTML = alerts.map(alert => `
        <div class="alert ${alert.severity}">
            <span class="alert-icon">${icons[alert.severity] || 'â„¹ï¸'}</span>
            <span>${alert.message}</span>
        </div>
    `).join('');
}

function renderAttendance(checkins) {
    const container = document.getElementById('attendanceContent');

    if (!checkins || checkins.length === 0) {
        container.innerHTML = '<div class="empty-state">ì˜¤ëŠ˜ ì¶œì„í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <ul class="checkin-list">
            ${checkins.map(c => `
                <li class="checkin-item">
                    <div>
                        <span class="checkin-name">${c.member_name}</span>
                        <span class="checkin-type">${getAttendanceTypeLabel(c.attendance_type)}</span>
                    </div>
                    <span class="checkin-time">${formatTime(c.check_in_at)}</span>
                </li>
            `).join('')}
        </ul>
    `;
}

async function loadTeamRoster() {
    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };
        const response = await fetch(`${API_BASE}/players/team/roster${API_SUFFIX}`, { headers });

        if (!response.ok) throw new Error('ë¡œìŠ¤í„° ë¡œë“œ ì‹¤íŒ¨');

        const data = await response.json();
        renderRoster(data);

    } catch (error) {
        console.error('Roster error:', error);
        document.getElementById('rosterContent').innerHTML =
            '<div class="empty-state">ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    }
}

function renderRoster(data) {
    const container = document.getElementById('rosterContent');

    if (!data.players || data.players.length === 0) {
        container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <table class="roster-table">
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ì—­í• </th>
                    <th>ë¬´ê¸°</th>
                    <th>ëŒ€íšŒ ìˆ˜</th>
                    <th>ìµœê·¼ ê²°ê³¼</th>
                    <th>ìƒì„¸</th>
                </tr>
            </thead>
            <tbody>
                ${data.players.map(player => `
                    <tr>
                        <td class="player-name">
                            ${player.player_id
                                ? `<a href="/player/${player.player_id}">${player.name}</a>`
                                : player.name}
                        </td>
                        <td>
                            <span class="role-badge ${getRoleClass(player.club_role)}">
                                ${getRoleLabel(player.club_role)}
                            </span>
                        </td>
                        <td>
                            ${player.weapon
                                ? `<span class="weapon-badge">${player.weapon}</span>`
                                : '-'}
                        </td>
                        <td class="stat-value">${player.competition_count || 0}</td>
                        <td>${player.recent_result || '-'}</td>
                        <td>
                            ${player.player_id
                                ? `<a href="/club/players/${player.player_id}/profile" class="action-btn secondary">ìƒì„¸</a>`
                                : '<span style="color:#999">ë¯¸ì—°ê²°</span>'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Helpers
function formatCurrency(amount) {
    return new Intl.NumberFormat('ko-KR').format(amount || 0);
}

function formatTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

function getAttendanceTypeLabel(type) {
    const labels = {
        'regular': 'ì •ê·œ í›ˆë ¨',
        'lesson': 'ë ˆìŠ¨',
        'competition': 'ëŒ€íšŒ',
        'makeup': 'ë³´ê°•',
        'trial': 'ì²´í—˜'
    };
    return labels[type] || type;
}

function getRoleLabel(role) {
    const labels = {
        'owner': 'ëŒ€í‘œ',
        'head_coach': 'ìˆ˜ì„ì½”ì¹˜',
        'coach': 'ì½”ì¹˜',
        'assistant': 'ë³´ì¡°ì½”ì¹˜',
        'student': 'ìˆ˜ê°•ìƒ',
        'parent': 'í•™ë¶€ëª¨',
        'staff': 'ìŠ¤íƒœí”„'
    };
    return labels[role] || role;
}

function getRoleClass(role) {
    if (['owner', 'head_coach', 'coach', 'assistant'].includes(role)) return 'coach';
    if (role === 'student') return 'student';
    if (role === 'owner') return 'owner';
    return '';
}

// Initialize
document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
