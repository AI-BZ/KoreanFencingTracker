{% extends "base.html" %}

{% block title %}í´ëŸ½ ëŒ€ì‹œë³´ë“œ - Korean Fencing Tracker{% endblock %}

{% block extra_css %}
<style>
.club-dashboard {
    padding: 2rem 0;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    font-size: 1.8rem;
    color: #1a1a2e;
}

.dashboard-header .club-name {
    color: #667eea;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.dashboard-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.card-header h3 {
    font-size: 1rem;
    color: #666;
    font-weight: 500;
}

.card-header .icon {
    font-size: 1.5rem;
}

.card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1a1a2e;
}

.card-value.highlight {
    color: #667eea;
}

.card-value.warning {
    color: #f5a623;
}

.card-value.success {
    color: #4caf50;
}

.card-subtitle {
    font-size: 0.9rem;
    color: #888;
    margin-top: 0.5rem;
}

/* Team Roster */
.roster-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.roster-section h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #1a1a2e;
}

.roster-table {
    width: 100%;
    border-collapse: collapse;
}

.roster-table th,
.roster-table td {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.roster-table th {
    font-weight: 600;
    color: #666;
    font-size: 0.85rem;
    text-transform: uppercase;
}

.roster-table tr:hover {
    background: #f8f9ff;
}

.player-name {
    font-weight: 600;
    color: #1a1a2e;
}

.player-name a {
    color: inherit;
    text-decoration: none;
}

.player-name a:hover {
    color: #667eea;
}

.role-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.role-badge.coach {
    background: #e3f2fd;
    color: #1976d2;
}

.role-badge.student {
    background: #f3e5f5;
    color: #7b1fa2;
}

.role-badge.owner {
    background: #fff3e0;
    color: #e65100;
}

.weapon-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    background: #f5f5f5;
    color: #666;
}

.stat-value {
    font-weight: 600;
    color: #667eea;
}

/* Today's Attendance */
.attendance-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.attendance-section h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #1a1a2e;
}

.checkin-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checkin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 0;
    border-bottom: 1px solid #eee;
}

.checkin-item:last-child {
    border-bottom: none;
}

.checkin-name {
    font-weight: 600;
}

.checkin-time {
    color: #888;
    font-size: 0.9rem;
}

.checkin-type {
    font-size: 0.8rem;
    color: #667eea;
}

/* Alerts */
.alerts-section {
    margin-bottom: 2rem;
}

.alert {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.alert.warning {
    background: #fff8e1;
    border: 1px solid #ffcc02;
}

.alert.info {
    background: #e3f2fd;
    border: 1px solid #90caf9;
}

.alert.error {
    background: #ffebee;
    border: 1px solid #ef9a9a;
}

.alert-icon {
    font-size: 1.2rem;
}

/* Loading */
.loading {
    text-align: center;
    padding: 3rem;
    color: #888;
}

.loading::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: #888;
}

/* Actions */
.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.action-btn:hover {
    background: #5a6fd6;
}

.action-btn.secondary {
    background: #f5f5f5;
    color: #333;
}

.action-btn.secondary:hover {
    background: #eee;
}

/* Role Label */
.role-label {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.2rem 0.6rem;
    background: #667eea;
    color: white;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    vertical-align: middle;
}

/* Owner Sections */
.owner-section {
    border-left: 4px solid #667eea;
}

/* Report Grid */
.report-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.report-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9ff;
    border-radius: 8px;
}

.report-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a2e;
}

.report-value.warning {
    color: #f5a623;
}

.report-label {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.3rem;
}

/* Messages List */
.messages-list {
    max-height: 300px;
    overflow-y: auto;
}

.message-item {
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.message-item:last-child {
    border-bottom: none;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.message-title {
    font-weight: 600;
    color: #1a1a2e;
}

.message-meta {
    font-size: 0.8rem;
    color: #888;
}

.message-content {
    font-size: 0.9rem;
    color: #555;
}

.message-target {
    display: inline-block;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 0.7rem;
    background: #e3f2fd;
    color: #1976d2;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #eee;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #888;
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-group input[type="text"],
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
}

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #eee;
}

/* Announcements List */
.announcements-list {
    max-height: 400px;
    overflow-y: auto;
}

.announcement-item {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
}

.announcement-item:last-child {
    border-bottom: none;
}

.announcement-item:hover {
    background: #f8f9ff;
}

.announcement-item.pinned {
    background: #fff8e1;
    border-left: 3px solid #ffc107;
}

.announcement-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.announcement-title {
    font-weight: 600;
    color: #1a1a2e;
}

.pin-badge {
    font-size: 0.75rem;
    color: #f5a623;
}

.announcement-content {
    font-size: 0.9rem;
    color: #555;
    line-height: 1.5;
    margin-bottom: 0.5rem;
}

.announcement-meta {
    font-size: 0.8rem;
    color: #888;
}
</style>
{% endblock %}

{% block content %}
<div class="container club-dashboard">
    <div class="dashboard-header">
        <h1>
            <span class="club-name" id="clubName">Loading...</span> ëŒ€ì‹œë³´ë“œ
        </h1>
        <div class="actions" id="headerActions">
            <button class="action-btn" onclick="openAnnouncementModal()">
                ğŸ“¢ ê³µì§€ ì‘ì„±
            </button>
            <!-- íšŒê³„ê´€ë¦¬ ë²„íŠ¼ì€ ownerì—ê²Œë§Œ ë™ì ìœ¼ë¡œ í‘œì‹œ -->
        </div>
    </div>

    <!-- Alerts -->
    <div class="alerts-section" id="alertsSection"></div>

    <!-- Stats Grid -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì˜¤ëŠ˜ ì¶œì„</h3>
                <span class="icon">ğŸ“‹</span>
            </div>
            <div class="card-value highlight" id="todayAttendance">-</div>
            <div class="card-subtitle">ëª… ì²´í¬ì¸</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì „ì²´ íšŒì›</h3>
                <span class="icon">ğŸ‘¥</span>
            </div>
            <div class="card-value" id="totalMembers">-</div>
            <div class="card-subtitle">ìˆ˜ê°•ìƒ <span id="studentCount">-</span>ëª… / ì½”ì¹˜ <span id="coachCount">-</span>ëª…</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì´ë²ˆ ì£¼ í›ˆë ¨</h3>
                <span class="icon">ğŸ—“ï¸</span>
            </div>
            <div class="card-value" id="weeklyTraining">-</div>
            <div class="card-subtitle">íšŒ ì˜ˆì •</div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <h3>ì˜ˆì • ëŒ€íšŒ</h3>
                <span class="icon">ğŸ†</span>
            </div>
            <div class="card-value" id="upcomingComps">-</div>
            <div class="card-subtitle">ê±´</div>
        </div>
    </div>

    <!-- Team Roster -->
    <div class="roster-section">
        <h2>ğŸ† ì†Œì† ì„ ìˆ˜ í˜„í™©</h2>
        <div id="rosterContent">
            <div class="loading">ì„ ìˆ˜ ë°ì´í„° ë¡œë”© ì¤‘</div>
        </div>
    </div>

    <!-- Announcements Section (ê³µì§€ì‚¬í•­) -->
    <div class="roster-section">
        <h2>ğŸ“¢ í´ëŸ½ ê³µì§€ì‚¬í•­</h2>
        <div id="announcementsContent">
            <div class="loading">ê³µì§€ì‚¬í•­ ë¡œë”© ì¤‘</div>
        </div>
    </div>

    <!-- Today's Attendance -->
    <div class="attendance-section">
        <h2>ğŸ“‹ ì˜¤ëŠ˜ ì¶œì„ í˜„í™©</h2>
        <div id="attendanceContent">
            <div class="loading">ì¶œì„ ë°ì´í„° ë¡œë”© ì¤‘</div>
        </div>
    </div>

    <!-- Owner-only Sections (ê°ë… ì „ìš©) -->
    <div id="ownerSections" style="display: none;">
        <!-- Director Messages -->
        <div class="dashboard-card owner-section" style="margin-top: 2rem;">
            <div class="card-header">
                <h3>ğŸ“£ ê°ë… ë©”ì„¸ì§€</h3>
                <button class="action-btn secondary" onclick="openMessageModal()">+ ìƒˆ ë©”ì„¸ì§€</button>
            </div>
            <div id="directorMessages" class="messages-list">
                <div class="loading">ë©”ì„¸ì§€ ë¡œë”© ì¤‘</div>
            </div>
        </div>

        <!-- Monthly Report -->
        <div class="dashboard-card owner-section" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3>ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</h3>
                <span class="icon">ğŸ“ˆ</span>
            </div>
            <div id="monthlyReport" class="report-content">
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-value" id="monthlyRevenue">-</div>
                        <div class="report-label">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="monthlyAttendance">-</div>
                        <div class="report-label">ì›”ê°„ ì¶œì„ë¥ </div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="monthlyNewMembers">-</div>
                        <div class="report-label">ì‹ ê·œ íšŒì›</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value warning" id="monthlyOverdue">-</div>
                        <div class="report-label">ë¯¸ë‚© ê±´ìˆ˜</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Announcement Modal (ê³µì§€ì‚¬í•­ ì‘ì„±) -->
<div id="announcementModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
            <button class="close-btn" onclick="closeAnnouncementModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ì œëª©</label>
                <input type="text" id="announcementTitle" placeholder="ê³µì§€ì‚¬í•­ ì œëª©">
            </div>
            <div class="form-group">
                <label>ë‚´ìš©</label>
                <textarea id="announcementContent" rows="6" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="announcementPinned"> ìƒë‹¨ ê³ ì •
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary" onclick="closeAnnouncementModal()">ì·¨ì†Œ</button>
            <button class="action-btn" onclick="saveAnnouncement()">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- Message Modal (ê°ë… ë©”ì„¸ì§€) -->
<div id="messageModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“£ ê°ë… ë©”ì„¸ì§€ ì‘ì„±</h3>
            <button class="close-btn" onclick="closeMessageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ëŒ€ìƒ</label>
                <select id="messageTarget">
                    <option value="all">ì „ì²´ íšŒì›</option>
                    <option value="students">ìˆ˜ê°•ìƒë§Œ</option>
                    <option value="coaches">ì½”ì¹˜ì§„ë§Œ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì œëª©</label>
                <input type="text" id="messageTitle" placeholder="ë©”ì„¸ì§€ ì œëª©">
            </div>
            <div class="form-group">
                <label>ë‚´ìš©</label>
                <textarea id="messageContent" rows="4" placeholder="ë©”ì„¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="sendKakao"> ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œë„ ë°œì†¡
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn secondary" onclick="closeMessageModal()">ì·¨ì†Œ</button>
            <button class="action-btn" onclick="sendDirectorMessage()">ë°œì†¡</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ê¸°ë³¸ í™œì„±í™” (ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì™„ì„± ì „ê¹Œì§€)
// TODO: ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì™„ì„± í›„ falseë¡œ ë³€ê²½
const TEST_MODE = true;
const API_BASE = '/api/club';
const API_SUFFIX = TEST_MODE ? '?test=1' : '';

// í˜„ì¬ ì‚¬ìš©ì ì—­í•  (ì„œë²„ì—ì„œ ì „ë‹¬)
const USER_ROLE = '{{ user_role | default("coach") }}';

// ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
async function loadDashboard() {
    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };
        const response = await fetch(`${API_BASE}/dashboard${API_SUFFIX}`, { headers });

        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/auth/login?redirect=/club/';
                return;
            }
            throw new Error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨');
        }

        const data = await response.json();
        renderDashboard(data);

    } catch (error) {
        console.error('Dashboard error:', error);
        document.querySelector('.club-dashboard').innerHTML = `
            <div class="empty-state">
                <p>ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p><a href="/auth/login?redirect=/club/">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>
        `;
    }
}

function renderDashboard(data) {
    // Club name
    document.getElementById('clubName').textContent = data.organization_name;

    // Stats
    document.getElementById('todayAttendance').textContent = data.today_attendance;
    document.getElementById('totalMembers').textContent = data.total_members;
    document.getElementById('studentCount').textContent = data.active_students;
    document.getElementById('coachCount').textContent = data.active_coaches;
    document.getElementById('weeklyTraining').textContent = data.weekly_training || 5;  // ê¸°ë³¸ê°’
    document.getElementById('upcomingComps').textContent = data.upcoming_competitions?.length || 0;

    // Alerts - ownerëŠ” ëª¨ë“  ì•Œë¦¼, ì½”ì¹˜ëŠ” ë¹„ìš© ê´€ë ¨ í•„í„°ë§
    const filteredAlerts = (USER_ROLE === 'owner')
        ? (data.alerts || [])
        : (data.alerts || []).filter(a => a.alert_type !== 'overdue_fee');
    renderAlerts(filteredAlerts);

    // Attendance
    renderAttendance(data.today_checkins);

    // Load team roster separately (í•™ìƒë§Œ)
    loadTeamRoster();

    // Load announcements (ê³µì§€ì‚¬í•­)
    loadAnnouncements();

    // ì—­í• ë³„ UI ì¡°ì •
    setupRoleBasedUI();
}

function setupRoleBasedUI() {
    // íšŒê³„ê´€ë¦¬ ë²„íŠ¼ (ownerë§Œ)
    if (USER_ROLE === 'owner') {
        addAccountingButton();
        loadOwnerSections();
    }

    // ì—­í•  í‘œì‹œ
    const roleLabel = document.createElement('span');
    roleLabel.className = 'role-label';
    roleLabel.textContent = getRoleLabel(USER_ROLE);
    document.querySelector('.dashboard-header h1')?.appendChild(roleLabel);
}

function addAccountingButton() {
    const actionsDiv = document.getElementById('headerActions');
    if (!actionsDiv.querySelector('.accounting-btn')) {
        const btn = document.createElement('button');
        btn.className = 'action-btn secondary accounting-btn';
        btn.innerHTML = 'ğŸ’° íšŒê³„ê´€ë¦¬';
        btn.onclick = () => location.href = '/club/accounting';
        actionsDiv.appendChild(btn);
    }
}

function renderAlerts(alerts) {
    const container = document.getElementById('alertsSection');
    if (!alerts || alerts.length === 0) {
        container.innerHTML = '';
        return;
    }

    const icons = {
        'warning': 'âš ï¸',
        'info': 'â„¹ï¸',
        'error': 'ğŸš¨'
    };

    container.innerHTML = alerts.map(alert => `
        <div class="alert ${alert.severity}">
            <span class="alert-icon">${icons[alert.severity] || 'â„¹ï¸'}</span>
            <span>${alert.message}</span>
        </div>
    `).join('');
}

function renderAttendance(checkins) {
    const container = document.getElementById('attendanceContent');

    if (!checkins || checkins.length === 0) {
        container.innerHTML = '<div class="empty-state">ì˜¤ëŠ˜ ì¶œì„í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <ul class="checkin-list">
            ${checkins.map(c => `
                <li class="checkin-item">
                    <div>
                        <span class="checkin-name">${c.member_name}</span>
                        <span class="checkin-type">${getAttendanceTypeLabel(c.attendance_type)}</span>
                    </div>
                    <span class="checkin-time">${formatTime(c.check_in_at)}</span>
                </li>
            `).join('')}
        </ul>
    `;
}

async function loadTeamRoster() {
    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };
        const response = await fetch(`${API_BASE}/players/team/roster${API_SUFFIX}`, { headers });

        if (!response.ok) throw new Error('ë¡œìŠ¤í„° ë¡œë“œ ì‹¤íŒ¨');

        const data = await response.json();
        renderRoster(data);

    } catch (error) {
        console.error('Roster error:', error);
        document.getElementById('rosterContent').innerHTML =
            '<div class="empty-state">ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    }
}

function renderRoster(data) {
    const container = document.getElementById('rosterContent');

    // í•™ìƒë§Œ í•„í„°ë§ (owner, coach, head_coach, staff ì œì™¸)
    const studentRoles = ['student', 'assistant'];
    const students = (data.players || []).filter(p => studentRoles.includes(p.club_role));

    if (students.length === 0) {
        container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <div style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
            ì´ ${students.length}ëª…ì˜ ì„ ìˆ˜
        </div>
        <table class="roster-table">
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ë¬´ê¸°</th>
                    <th>ëŒ€íšŒ ìˆ˜</th>
                    <th>ìµœê·¼ ê²°ê³¼</th>
                    <th>ìƒì„¸</th>
                </tr>
            </thead>
            <tbody>
                ${students.map(player => `
                    <tr>
                        <td class="player-name">
                            ${player.player_id
                                ? `<a href="/player/${player.player_id}">${player.name}</a>`
                                : player.name}
                        </td>
                        <td>
                            ${player.weapon
                                ? `<span class="weapon-badge">${player.weapon}</span>`
                                : '-'}
                        </td>
                        <td class="stat-value">${player.competition_count || 0}</td>
                        <td>${player.recent_result || '-'}</td>
                        <td>
                            ${player.player_id
                                ? `<a href="/player/${player.player_id}" class="action-btn secondary">ìƒì„¸</a>`
                                : '<span style="color:#999">ë¯¸ì—°ê²°</span>'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Helpers
function formatCurrency(amount) {
    return new Intl.NumberFormat('ko-KR').format(amount || 0);
}

function formatTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

function getAttendanceTypeLabel(type) {
    const labels = {
        'regular': 'ì •ê·œ í›ˆë ¨',
        'lesson': 'ë ˆìŠ¨',
        'competition': 'ëŒ€íšŒ',
        'makeup': 'ë³´ê°•',
        'trial': 'ì²´í—˜'
    };
    return labels[type] || type;
}

function getRoleLabel(role) {
    const labels = {
        'owner': 'ëŒ€í‘œ',
        'head_coach': 'ìˆ˜ì„ì½”ì¹˜',
        'coach': 'ì½”ì¹˜',
        'assistant': 'ë³´ì¡°ì½”ì¹˜',
        'student': 'ìˆ˜ê°•ìƒ',
        'parent': 'í•™ë¶€ëª¨',
        'staff': 'ìŠ¤íƒœí”„'
    };
    return labels[role] || role;
}

function getRoleClass(role) {
    if (['owner', 'head_coach', 'coach'].includes(role)) return 'coach';
    if (['student', 'assistant'].includes(role)) return 'student';
    if (role === 'owner') return 'owner';
    return '';
}

// Owner-only functions
function loadOwnerSections() {
    // Show owner sections
    document.getElementById('ownerSections').style.display = 'block';

    // Load director messages
    loadDirectorMessages();

    // Load monthly report
    loadMonthlyReport();
}

async function loadDirectorMessages() {
    const container = document.getElementById('directorMessages');

    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };

        const response = await fetch(`${API_BASE}/messages${API_SUFFIX}`, { headers });

        if (!response.ok) {
            // API ë¯¸êµ¬í˜„ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„°
            renderTestMessages();
            return;
        }

        const data = await response.json();
        renderMessages(data.messages || []);

    } catch (error) {
        console.error('Messages error:', error);
        renderTestMessages();
    }
}

function renderTestMessages() {
    const testData = [
        {
            id: 1,
            title: '12ì›” ëŒ€íšŒ ì°¸ê°€ ì•ˆë‚´',
            content: 'ì´ë²ˆ 12ì›” íšŒì¥ë°° ëŒ€íšŒì— ì°¸ê°€í•  ì„ ìˆ˜ë“¤ì€ 12ì›” 20ì¼ê¹Œì§€ ì‹ ì²­í•´ì£¼ì„¸ìš”.',
            target: 'all',
            created_at: '2024-12-15 10:00'
        },
        {
            id: 2,
            title: 'ì—°ë§ íœ´ê´€ ì•ˆë‚´',
            content: '12ì›” 30ì¼ ~ 1ì›” 2ì¼ê¹Œì§€ íœ´ê´€í•©ë‹ˆë‹¤. í›ˆë ¨ ì¼ì • ì°¸ê³  ë°”ëë‹ˆë‹¤.',
            target: 'all',
            created_at: '2024-12-10 14:00'
        },
        {
            id: 3,
            title: 'ì½”ì¹˜ íšŒì˜ ê³µì§€',
            content: 'ì´ë²ˆ ì£¼ ê¸ˆìš”ì¼ ì˜¤í›„ 7ì‹œì— ì½”ì¹˜ íšŒì˜ê°€ ìˆìŠµë‹ˆë‹¤.',
            target: 'coaches',
            created_at: '2024-12-08 09:00'
        }
    ];
    renderMessages(testData);
}

function renderMessages(messages) {
    const container = document.getElementById('directorMessages');

    if (!messages || messages.length === 0) {
        container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ë©”ì„¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    const targetLabels = {
        'all': 'ì „ì²´',
        'students': 'ìˆ˜ê°•ìƒ',
        'coaches': 'ì½”ì¹˜ì§„'
    };

    container.innerHTML = messages.map(m => `
        <div class="message-item">
            <div class="message-header">
                <span class="message-title">${m.title}</span>
                <span class="message-target">${targetLabels[m.target] || m.target}</span>
            </div>
            <div class="message-content">${m.content}</div>
            <div class="message-meta">${formatDateTime(m.created_at)}</div>
        </div>
    `).join('');
}

async function loadMonthlyReport() {
    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };

        const response = await fetch(`${API_BASE}/report/monthly${API_SUFFIX}`, { headers });

        if (!response.ok) {
            // í…ŒìŠ¤íŠ¸ ë°ì´í„°
            renderTestReport();
            return;
        }

        const data = await response.json();
        renderReport(data);

    } catch (error) {
        console.error('Report error:', error);
        renderTestReport();
    }
}

function renderTestReport() {
    document.getElementById('monthlyRevenue').textContent = 'â‚©3,200,000';
    document.getElementById('monthlyAttendance').textContent = '85%';
    document.getElementById('monthlyNewMembers').textContent = '2';
    document.getElementById('monthlyOverdue').textContent = '3';
}

function renderReport(data) {
    document.getElementById('monthlyRevenue').textContent = `â‚©${formatCurrency(data.revenue)}`;
    document.getElementById('monthlyAttendance').textContent = `${data.attendance_rate || 0}%`;
    document.getElementById('monthlyNewMembers').textContent = data.new_members || 0;
    document.getElementById('monthlyOverdue').textContent = data.overdue_count || 0;
}

// Modal functions
function openMessageModal() {
    document.getElementById('messageModal').style.display = 'flex';
}

function closeMessageModal() {
    document.getElementById('messageModal').style.display = 'none';
    // Clear form
    document.getElementById('messageTarget').value = 'all';
    document.getElementById('messageTitle').value = '';
    document.getElementById('messageContent').value = '';
    document.getElementById('sendKakao').checked = false;
}

async function sendDirectorMessage() {
    const target = document.getElementById('messageTarget').value;
    const title = document.getElementById('messageTitle').value;
    const content = document.getElementById('messageContent').value;
    const sendKakao = document.getElementById('sendKakao').checked;

    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const headers = {
            'Content-Type': 'application/json',
            ...(TEST_MODE ? {} : {'Authorization': `Bearer ${localStorage.getItem('access_token')}`})
        };

        const response = await fetch(`${API_BASE}/messages${API_SUFFIX}`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ target, title, content, send_kakao: sendKakao })
        });

        if (response.ok) {
            alert('ë©”ì„¸ì§€ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeMessageModal();
            loadDirectorMessages();
        } else {
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ì„±ê³µ ì²˜ë¦¬
            alert('ë©”ì„¸ì§€ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸)');
            closeMessageModal();
        }
    } catch (error) {
        console.error('Message send error:', error);
        alert('ë©”ì„¸ì§€ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function formatDateTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleDateString('ko-KR', {
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ==================== ê³µì§€ì‚¬í•­ Functions ====================

async function loadAnnouncements() {
    const container = document.getElementById('announcementsContent');

    try {
        const headers = TEST_MODE ? {} : {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        };

        const response = await fetch(`${API_BASE}/announcements${API_SUFFIX}`, { headers });

        if (!response.ok) {
            renderTestAnnouncements();
            return;
        }

        const data = await response.json();
        renderAnnouncements(data.announcements || []);

    } catch (error) {
        console.error('Announcements error:', error);
        renderTestAnnouncements();
    }
}

function renderTestAnnouncements() {
    const testData = [
        {
            id: 1,
            title: '12ì›” ëŒ€íšŒ ì°¸ê°€ ì•ˆë‚´',
            content: 'ì´ë²ˆ 12ì›” íšŒì¥ë°° ëŒ€íšŒì— ì°¸ê°€í•  ì„ ìˆ˜ë“¤ì€ 12ì›” 20ì¼ê¹Œì§€ ì‹ ì²­í•´ì£¼ì„¸ìš”. ì°¸ê°€ë¹„ëŠ” 30,000ì›ì´ë©°, ì¶œì¥ë¹„ëŠ” ë³„ë„ì…ë‹ˆë‹¤.',
            is_pinned: true,
            created_at: '2024-12-15 10:00',
            author: 'ìµœë³‘ì² '
        },
        {
            id: 2,
            title: 'ì—°ë§ íœ´ê´€ ì•ˆë‚´',
            content: '12ì›” 30ì¼ ~ 1ì›” 2ì¼ê¹Œì§€ íœ´ê´€í•©ë‹ˆë‹¤. í›ˆë ¨ ì¼ì • ì°¸ê³  ë°”ëë‹ˆë‹¤.',
            is_pinned: false,
            created_at: '2024-12-10 14:00',
            author: 'ìµœë³‘ì² '
        },
        {
            id: 3,
            title: 'ë ˆìŠ¨ ì‹œê°„ ë³€ê²½ ì•ˆë‚´',
            content: '12ì›” 20ì¼ë¶€í„° ê¸ˆìš”ì¼ ë ˆìŠ¨ ì‹œê°„ì´ 17:00ì—ì„œ 18:00ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.',
            is_pinned: false,
            created_at: '2024-12-08 09:00',
            author: 'ê¹€ì½”ì¹˜'
        }
    ];
    renderAnnouncements(testData);
}

function renderAnnouncements(announcements) {
    const container = document.getElementById('announcementsContent');

    if (!announcements || announcements.length === 0) {
        container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    container.innerHTML = `
        <div class="announcements-list">
            ${announcements.map(a => `
                <div class="announcement-item ${a.is_pinned ? 'pinned' : ''}">
                    <div class="announcement-header">
                        ${a.is_pinned ? '<span class="pin-badge">ğŸ“Œ ê³ ì •</span>' : ''}
                        <span class="announcement-title">${a.title}</span>
                    </div>
                    <div class="announcement-content">${a.content}</div>
                    <div class="announcement-meta">
                        <span>${a.author || 'ê´€ë¦¬ì'}</span> Â· <span>${formatDateTime(a.created_at)}</span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Announcement Modal Functions
function openAnnouncementModal() {
    document.getElementById('announcementModal').style.display = 'flex';
}

function closeAnnouncementModal() {
    document.getElementById('announcementModal').style.display = 'none';
    document.getElementById('announcementTitle').value = '';
    document.getElementById('announcementContent').value = '';
    document.getElementById('announcementPinned').checked = false;
}

async function saveAnnouncement() {
    const title = document.getElementById('announcementTitle').value;
    const content = document.getElementById('announcementContent').value;
    const isPinned = document.getElementById('announcementPinned').checked;

    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const headers = {
            'Content-Type': 'application/json',
            ...(TEST_MODE ? {} : {'Authorization': `Bearer ${localStorage.getItem('access_token')}`})
        };

        const response = await fetch(`${API_BASE}/announcements${API_SUFFIX}`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ title, content, is_pinned: isPinned })
        });

        if (response.ok) {
            alert('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeAnnouncementModal();
            loadAnnouncements();
        } else {
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ
            alert('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸)');
            closeAnnouncementModal();
        }
    } catch (error) {
        console.error('Announcement save error:', error);
        alert('ê³µì§€ì‚¬í•­ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
